@model BusinessAsUsual.Admin.Areas.Admin.Models.ProvisionCompanyViewModel

<h2>Provision New Company</h2>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">

            <!-- PANEL 1: BUSINESS TYPE -->
            <div class="card shadow-sm mb-4 gradient-card">
                <div class="card-header text-white">
                    <h5 class="mb-0">1. Select Business Type</h5>
                </div>
                <div class="card-body">
                    <label class="form-label fw-bold">Business Type</label>
                    <select id="BusinessType" class="form-select">
                        <option value="">Choose a business type...</option>
                        <option value="Retail">Retail</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Mining">Mining / Drilling</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Hospitality">Hospitality</option>
                        <option value="ProfessionalServices">Professional Services</option>
                    </select>
                    <small>Selecting a business type will auto‑select recommended modules.</small>
                </div>
            </div>

            <!-- PANEL 2: MODULES & SUBMODULES -->
            <div class="card shadow-sm mb-4 gradient-card">
                <div class="card-header text-white">
                    <h5 class="mb-0">2. Select Modules & Submodules</h5>
                </div>

                <div class="card-body">

                    <!-- TAB HEADERS -->
                    <ul class="nav nav-pills gap-2" id="moduleGroupTabs" role="tablist">
                        @for (int i = 0; i < Model.GroupedModules.Count; i++)
                        {
                            var group = Model.GroupedModules[i];
                            <li class="nav-item" role="presentation">
                                <button class="nav-link @(i == 0 ? "active" : "")"
                                        id="tab-@group.GroupName.Replace(" ", "")"
                                        data-bs-toggle="tab"
                                        data-bs-target="#pane-@group.GroupName.Replace(" ", "")"
                                        type="button"
                                        role="tab">
                                    @group.GroupName
                                </button>
                            </li>
                        }
                    </ul>

                    <!-- TAB CONTENT -->
                    <div class="tab-content mt-2" id="moduleGroupTabContent">

                        @for (int i = 0; i < Model.GroupedModules.Count; i++)
                        {
                            var group = Model.GroupedModules[i];

                            <div class="tab-pane fade @(i == 0 ? "show active" : "")"
                                 id="pane-@group.GroupName.Replace(" ", "")"
                                 role="tabpanel">

                                <div class="accordion" id="accordion-@group.GroupName.Replace(" ", "")">

                                    @foreach (var module in group.Modules)
                                    {
                                        <div class="accordion-item">

                                            <h2 class="accordion-header" id="heading-@module.Key">
                                                <div class="d-flex align-items-center">

                                                    <input type="checkbox"
                                                           class="form-check-input me-2 module-checkbox"
                                                           data-module="@module.Key"
                                                           value="@module.Key"
                                                           id="chk-@module.Key" />

                                                    <button class="accordion-button collapsed fw-bold flex-grow-1"
                                                            type="button"
                                                            data-bs-toggle="collapse"
                                                            data-bs-target="#collapse-@module.Key"
                                                            aria-expanded="false"
                                                            aria-controls="collapse-@module.Key">
                                                        @module.Name
                                                    </button>
                                                </div>
                                            </h2>

                                            <div id="collapse-@module.Key"
                                                 class="accordion-collapse collapse"
                                                 aria-labelledby="heading-@module.Key">

                                                <div class="accordion-body">

                                                    @foreach (var sub in module.Submodules)
                                                    {
                                                        <div class="form-check mb-1 ms-4">
                                                            <input type="checkbox"
                                                                   class="form-check-input submodule-checkbox"
                                                                   data-parent="@module.Key"
                                                                   value="@sub.Key"
                                                                   id="sub-@sub.Key" />

                                                            <label class="form-check-label" for="sub-@sub.Key">
                                                                @sub.Name
                                                            </label>
                                                        </div>
                                                    }

                                                </div>
                                            </div>
                                        </div>
                                    }

                                </div>

                            </div>
                        }

                    </div>

                    <!-- Hidden fields for backend -->
                    <input asp-for="Company.ModulesEnabled" type="hidden" id="ModulesEnabled" />
                    <input asp-for="Company.SubmodulesEnabled" type="hidden" id="SubmodulesEnabled" />

                </div>
            </div>

            <!-- PANEL 3: COMPANY DETAILS -->
            <div class="card shadow-sm mb-4 gradient-card">
                <div class="card-header text-white">
                    <h5 class="mb-0">3. Company Details</h5>
                </div>

                <div class="card-body">

                    <form asp-area="Admin" asp-controller="Company" asp-action="ProvisionCompany" method="post">

                        <div class="mb-3">
                            <label asp-for="Company.Name" class="form-label fw-bold"></label>
                            <input asp-for="Company.Name" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Company.AdminEmail" class="form-label fw-bold"></label>
                            <input asp-for="Company.AdminEmail" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label asp-for="Company.BillingPlan" class="form-label fw-bold"></label>
                            <select asp-for="Company.BillingPlan" class="form-select">
                                <option value="">Select a plan...</option>
                                <option value="Free">Free</option>
                                <option value="Standard">Standard</option>
                                <option value="Premium">Premium</option>
                                <option value="Enterprise">Enterprise</option>
                            </select>
                        </div>

                        <input asp-for="Company.ModulesEnabled" type="hidden" id="ModulesEnabledFinal" />
                        <input asp-for="Company.SubmodulesEnabled" type="hidden" id="SubmodulesEnabledFinal" />

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                Provision Company
                            </button>
                        </div>

                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .gradient-card {
        background: var(--gradient-card);
    }

    .form-check-label, .module-checkbox, .submodule-checkbox {
        cursor: pointer;
    }

    .form-check:hover {
        background-color: color-mix(in srgb, var(--bs-secondary) 25%, transparent);
        color: var(--bs-secondary);
    }

    .module-checkbox {
        margin: 0 0.5rem;
    }
</style>

@section Scripts {
    <script>
        const businessTypeModules = {

            // ============================================================
            // RETAIL
            // ============================================================
            Retail: [
                "Products",
                "Inventory",
                "Orders",
                "POS",
                "Customers",
                "Suppliers",
                "Purchasing",
                "Warehousing",
                "Payments",
                "Billing",
                "Invoicing",
                "Accounting",
                "Reporting",
                "Staff",
                "Timekeeping",
                "HR"
            ],

            // ============================================================
            // MANUFACTURING
            // ============================================================
            Manufacturing: [
                "Products",
                "Inventory",
                "Warehousing",
                "Equipment",
                "Maintenance",
                "QualityControl",
                "Replenishment",
                "Forecasting",
                "Procurement",
                "Purchasing",
                "Suppliers",
                "Projects",
                "Tasks",
                "Workflows",
                "Scheduling",
                "AssetManagement",
                "Compliance",
                "Accounting",
                "GeneralLedger",
                "Reporting",
                "Staff",
                "Timekeeping",
                "HR"
            ],

            // ============================================================
            // MINING / DRILLING
            // ============================================================
            Mining: [
                "Equipment",
                "Maintenance",
                "Safety",
                "Compliance",
                "Vehicles",
                "FleetManagement",
                "Logistics",
                "Routing",
                "Projects",
                "Tasks",
                "Documents",
                "Reporting",
                "Staff",
                "Timekeeping",
                "HR",
                "Accounting"
            ],

            // ============================================================
            // LOGISTICS / TRANSPORT
            // ============================================================
            Logistics: [
                "Vehicles",
                "FleetManagement",
                "Routing",
                "Dispatch",
                "Logistics",
                "Warehousing",
                "Inventory",
                "Orders",
                "Customers",
                "Suppliers",
                "Scheduling",
                "Messaging",
                "Reporting",
                "Accounting",
                "Staff",
                "Timekeeping",
                "HR"
            ],

            // ============================================================
            // HEALTHCARE
            // ============================================================
            Healthcare: [
                "Patients",
                "ClinicalNotes",
                "Scheduling",
                "Billing",
                "Invoicing",
                "Documents",
                "Messaging",
                "Inventory",
                "Equipment",
                "Compliance",
                "Reporting",
                "Staff",
                "Timekeeping",
                "HR",
                "Accounting"
            ],

            // ============================================================
            // HOSPITALITY
            // ============================================================
            Hospitality: [
                "Menu",
                "Orders",
                "Reservations",
                "Events",
                "Customers",
                "Staff",
                "Scheduling",
                "Inventory",
                "Purchasing",
                "Payments",
                "Billing",
                "Invoicing",
                "Messaging",
                "Reporting",
                "Timekeeping",
                "HR",
                "Accounting"
            ],

            // ============================================================
            // PROFESSIONAL SERVICES
            // ============================================================
            ProfessionalServices: [
                "Contracts",
                "Projects",
                "Tasks",
                "FieldService",
                "Services",
                "Documents",
                "Messaging",
                "Customers",
                "Quotes",
                "Billing",
                "Invoicing",
                "Reporting",
                "Staff",
                "Timekeeping",
                "HR",
                "Accounting"
            ]
        };

        function resetAllModules() {
            // Uncheck all module checkboxes
            document.querySelectorAll(".module-checkbox").forEach(cb => {
                cb.checked = false;
            });

            // Uncheck all submodule checkboxes
            document.querySelectorAll(".submodule-checkbox").forEach(cb => {
                cb.checked = false;
            });

            // Collapse all accordion panels
            document.querySelectorAll(".accordion-collapse.show").forEach(panel => {
                panel.classList.remove("show");
            });

            // Also collapse any that are "collapsing" mid-animation
            document.querySelectorAll(".accordion-collapse.collapsing").forEach(panel => {
                panel.classList.remove("collapsing");
                panel.classList.remove("show");
            });

            // Reset all accordion buttons to collapsed state
            document.querySelectorAll(".accordion-button").forEach(btn => {
                btn.classList.add("collapsed");
                btn.setAttribute("aria-expanded", "false");
            });

            // 🔥 Clear hidden fields
            document.getElementById("ModulesEnabled").value = "";
            document.getElementById("SubmodulesEnabled").value = "";
        }

        function updateHiddenFields() {
            const modules = [...document.querySelectorAll(".module-checkbox:checked")]
                .map(cb => cb.dataset.module);

            const submodules = [...document.querySelectorAll(".submodule-checkbox:checked")]
                .map(cb => cb.value);

            document.getElementById("ModulesEnabled").value = modules.join(",");
            document.getElementById("SubmodulesEnabled").value = submodules.join(",");
        }

        // BUSINESS TYPE CHANGE
        document.getElementById("BusinessType").addEventListener("change", function () {
            const selected = this.value;

            // 1. Reset everything
            resetAllModules();

            // 2. Apply defaults
            const modules = businessTypeModules[selected] || [];

            document.querySelectorAll(".module-checkbox").forEach(cb => {
                const moduleKey = cb.dataset.module;

                if (modules.includes(moduleKey)) {
                    cb.checked = true;
                    cb.dispatchEvent(new Event("change")); // triggers unified logic
                }
            });

            updateHiddenFields();
        });


        // UNIFIED MODULE CHECKBOX LOGIC
        document.querySelectorAll(".module-checkbox").forEach(cb => {
            cb.addEventListener("change", function () {
                const moduleKey = this.dataset.module;

                // Auto-select submodules
                const submodules = document.querySelectorAll(`.submodule-checkbox[data-parent="${moduleKey}"]`);
                submodules.forEach(sm => sm.checked = this.checked);

                // Auto-expand accordion
                if (this.checked) {
                    const btn = document.querySelector(`button[data-bs-target="#collapse-${moduleKey}"]`);
                    if (btn) btn.click();
                }

                updateHiddenFields();
            });
        });


        // SUBMODULE CHECKBOXES UPDATE HIDDEN FIELDS
        document.querySelectorAll(".submodule-checkbox").forEach(sm => {
            sm.addEventListener("change", updateHiddenFields);
        });
    </script>

    <script>
        function buildProvisioningPayload() {
            const businessType = document.getElementById("businessType").value;

            const modules = [...document.querySelectorAll(".module-checkbox:checked")]
                .map(cb => cb.dataset.module);

            const submodules = [...document.querySelectorAll(".submodule:checked")]
                .map(sm => sm.dataset.sub);

            return {
                companyName: document.getElementById("companyName").value,
                ein: document.getElementById("ein").value,
                address: document.getElementById("address").value,
                contactEmail: document.getElementById("contactEmail").value,
                businessType,
                modules,
                submodules
            };
        }

        async function submitProvisioning() {
            const payload = buildProvisioningPayload();

            const response = await fetch("/api/provision-company", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            console.log("Provisioning result:", result);
        }
    </script>
    
    <script>
        function updateSelections() {
            const modules = Array.from(document.querySelectorAll(".module-checkbox:checked"))
                .map(x => x.value);

            const submodules = Array.from(document.querySelectorAll(".submodule-checkbox:checked"))
                .map(x => x.value);

            document.getElementById("ModulesEnabled").value = modules.join(",");
            document.getElementById("SubmodulesEnabled").value = submodules.join(",");

            document.getElementById("ModulesEnabledFinal").value = modules.join(",");
            document.getElementById("SubmodulesEnabledFinal").value = submodules.join(",");
        }

        document.querySelectorAll(".module-checkbox").forEach(cb => {
            cb.addEventListener("change", () => {
                const moduleKey = cb.value;

                document.querySelectorAll(`.submodule-checkbox[data-module='${moduleKey}']`)
                    .forEach(sub => sub.checked = cb.checked);

                updateSelections();
            });
        });

        document.querySelectorAll(".submodule-checkbox").forEach(cb => {
            cb.addEventListener("change", () => {
                const moduleKey = cb.dataset.module;

                const anyChecked = Array.from(
                    document.querySelectorAll(`.submodule-checkbox[data-module='${moduleKey}']`)
                ).some(x => x.checked);

                document.getElementById(`chk-${moduleKey}`).checked = anyChecked;

                updateSelections();
            });
        });
    </script>
}
